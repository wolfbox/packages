# Maintainer: Andrew Aldridge <i80and@foxquill.com>
# Derived from Arch Linux

pkgname=xf86-video-sisimedia
pkgver=0.9.1
pkgrel=1
pkgdesc="X.org SiS 671 video driver"
arch=('x86_64')
url="http://www.linuxconsulting.ro/xorg-drivers/"
license=('custom')
depends=('glibc')
makedepends=('xorg-server-devel' 'X-ABI-VIDEODRV_VERSION=18' 'xf86dgaproto')
conflicts=('xorg-server<1.16' 'X-ABI-VIDEODRV_VERSION<18' 'X-ABI-VIDEODRV_VERSION>=19')
source=(ftp://ftp.archlinux.org/other/xf86-video-sisimedia/xf86-video-sisimedia-0.9.1_20091203.tar.bz2
        xf86-video-sis-0.9.1-20102701.patch
        0002-Remove-XFree86-Misc-PassMessage-support.patch
        0003-Fix-build-with-Werror-format-security.patch
        0005-Fix-backlight-off-on-SiS30x.-video-bridges.patch
        0006-Add-IgnoreHotkeyFlag-driver-option.patch
        xf86-video-sis-0.9.1-dump-regs-after-video-init.patch
        0007-Remove-useless-loader-symbol-lists.patch
        0008-update-to-xextproto-7-1-support.patch
        0009-update-for-rac-removal.patch
        0010-change-to-use-abi-version-check.patch
        0011-more-rac-removal.patch
        0001-Remove-xorgconfig-xorgcfg-from-See-Also-list-in-man-.patch
        0004-Make-sisRegs3D4-big-enough-to-hold-all-values-writte.patch
        0005-Correct-bounds-check-of-blitClip-array-access.patch
        xserver19.patch
        xserver112.patch
        pciTag-removal-workaround.patch
        Untangle-XF86DRI.patch
        swap-func-rename.patch
        xf86MapDomainMemory-pci_device_map_legacy.patch
        sync-with-freedesktop.patch
        fix-xv-crash.patch
        sisimedia-no-xaa.patch
        sisimedia-xorg-1.13.patch
        deprecated-sym2.patch
        disable-UploadToScreen-DownloadFromScreen.patch
        remove_mibstore.h.patch
        COPYING)
sha256sums=('e2084179ba06634311cdac295ce18a61226bbbe04c3567b5b7f59af37e07560d'
            'd19c73c04722c265428bf0c3b1b7db28e409a692e9697b96629fd8c5408a9f3b'
            '74b27d8ac93305d904cbf8498ad54e7f60c24850f5394d415c10c8b0926375f0'
            '45e7fff54e313918acdd8e1d40b704e519f97e476b53dfcd6c421bbb1d87f448'
            'b648f158667754bc56b2e397d0397e922fd328dbe2b30b8576f88e5530d6cf90'
            '272ae8442b0dac563206372a4a730c1ae0257a69fb2a4792f7aaa367e73de9cd'
            '4d6920c5f4e6a433c5d011e6b793538a0a6f783d40493518b467119061e2ed86'
            '0823e3a8adfe33af1c1c9edcb924d71e002e7de45e226d52e48d89444fe01771'
            '3a9c77e06c0e1acdbb195d9558983161d7ee2dded46eadd61b8d70e412ac1ef7'
            '0dffa2d2a11af9132a6800131f60a01f1e2f45ab5e4e41e4324316b5413e9201'
            '545524457bb679cfffbabd84790aacd79ff377a8ac8caca2f235121a35b793ae'
            '0c85ae954f09325afbb0d22256adfd40a160d21df4ee2d6283040ffcc7252dd2'
            'a3d332d419fe22d428c2948eaf5614cfdad6c4ac980e5ace9993c62831ec1f2a'
            '774abd7d1da41173e5ca069b1f76c3f40ddada9435b0273bfd589873ad1b3fe2'
            'b1a9a3266281b9639cb6c167886fa056a1ebc8946f01235442f363f623f0cd98'
            '8c4df54366bb2be3c5a454a7722eefe07a3f5fb31b8ae75e8b41524f5d7ed0d1'
            'dbee6f5a70ebf7a5d2e3533b18e3c8f9ed7f88b562c5f77c5405ecb76c645452'
            'ece81f169951039186276ca5170d570a8ae95cac84a1ef51f2e2954efbfac9b7'
            '6ecba0fdbbf7b25fb016174423d715246213c9ec0f670dbcbc84e2754de36071'
            '4afd9b42afdbc7fb57e301c2fc4310eb3839fc34259dda532204b6bb738207ef'
            '59925d4c4f87145dc0a8041c8001b1a9fc3a0a6b5afa37c9caca1278f5eda2a3'
            'a75ed4faf9fdaa6f261cfdabe94fd1603533e94dcf5a03ec5c1583bcc6e3a9a5'
            '4e6050a8eb3befb49ec8f918fb7d393e55171a2d04581a07438bda510017d9eb'
            '188c260a4681f8c93ee3f75224c18e3b3067d0a8776d7b35a0378825352ba6ba'
            '001b820d1f45b4eeee1b8dc8afa3fa67d1a8c3d9a30328d5fffc043e7f822d22'
            'd3cb597c0f9911ff218c2b1c0a8abe93691d92be307366e2040ab2e20c7919a1'
            'f2d23f9f2df0be527ace9b441cf58876f6cc385aafaa20fbea2b3bba4a79bc8a'
            'c41382c7d6a54610040d05e9111281e80535d58250d39707dd8e5cfe3e3f3ccc'
            'e7958f9497a4daa3ae5aeaf885e4565520af2c540b6e4e04b52bf95d41d56c39')

prepare() {
  cd "${srcdir}/xf86-video-sis-${pkgver}"
  patch -Np1 -i "${srcdir}/xf86-video-sis-0.9.1-20102701.patch"
  patch -Np1 -i "${srcdir}/0002-Remove-XFree86-Misc-PassMessage-support.patch"
  patch -Np1 -i "${srcdir}/0003-Fix-build-with-Werror-format-security.patch"
  patch -Np1 -i "${srcdir}/0005-Fix-backlight-off-on-SiS30x.-video-bridges.patch"
  patch -Np1 -i "${srcdir}/0006-Add-IgnoreHotkeyFlag-driver-option.patch"
  patch -Np1 -i "${srcdir}/xf86-video-sis-0.9.1-dump-regs-after-video-init.patch"
  patch -Np1 -i "${srcdir}/0007-Remove-useless-loader-symbol-lists.patch"
  patch -Np1 -i "${srcdir}/0008-update-to-xextproto-7-1-support.patch"
  patch -Np1 -i "${srcdir}/0009-update-for-rac-removal.patch"
  patch -Np1 -i "${srcdir}/0010-change-to-use-abi-version-check.patch"
  patch -Np1 -i "${srcdir}/0011-more-rac-removal.patch"
  patch -Np1 -i "${srcdir}/0001-Remove-xorgconfig-xorgcfg-from-See-Also-list-in-man-.patch"
  patch -Np1 -i "${srcdir}/0004-Make-sisRegs3D4-big-enough-to-hold-all-values-writte.patch"
  patch -Np1 -i "${srcdir}/0005-Correct-bounds-check-of-blitClip-array-access.patch"
  patch -Np1 -i "${srcdir}/xserver19.patch"
  patch -Np1 -i "${srcdir}/xserver112.patch"
  patch -Np1 -i "${srcdir}/pciTag-removal-workaround.patch"
  patch -Np1 -i "${srcdir}/Untangle-XF86DRI.patch"
  patch -Np1 -i "${srcdir}/swap-func-rename.patch"
  patch -Np1 -i "${srcdir}/xf86MapDomainMemory-pci_device_map_legacy.patch"
  patch -Np1 -i "${srcdir}/sync-with-freedesktop.patch"
  patch -Np0 -i "${srcdir}/fix-xv-crash.patch"
  patch -Np1 -i "${srcdir}/sisimedia-no-xaa.patch"
  patch -Np1 -i "${srcdir}/sisimedia-xorg-1.13.patch"
  patch -Np1 -i "${srcdir}/remove_mibstore.h.patch"

  patch -Np1 -i "${srcdir}/deprecated-sym2.patch"
  patch -Np1 -i "${srcdir}/disable-UploadToScreen-DownloadFromScreen.patch"

  sed -i -e 's,sis_drv,sisimedia_drv,g' src/Makefile.am
  sed -i -e 's,\"sis\",\"sisimedia\",g' src/sis.h
  sed -i -e 's,sisModuleData,sisimediaModuleData,g' src/sis_driver.c

  sed -i -e 's/AM_CONFIG_HEADER/AC_CONFIG_HEADERS/' configure.ac

  autoreconf -fi
}

build() {
  cd "${srcdir}/xf86-video-sis-${pkgver}"

  ./configure --prefix=/usr --disable-dri
  make
}

package() {
  cd "${srcdir}/xf86-video-sis-${pkgver}"
  make DESTDIR="${pkgdir}" install

  rm -rf "${pkgdir}/usr/share/man"

  install -m755 -d "${pkgdir}/usr/share/doc/${pkgname}"
  install -m644 "${srcdir}/COPYING" "${pkgdir}/usr/share/doc/${pkgname}/"
}
