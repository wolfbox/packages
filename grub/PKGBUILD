pkgname=grub
_pkgver=2.02
_versuffix=beta2
_GRUB_GIT_TAG=grub-${_pkgver}-${_versuffix}
pkgver=${_pkgver}_${_versuffix}
pkgrel=1
pkgdesc="The GNU GRUB system bootloader"
arch=("x86_64")
url="http://www.gnu.org/software/grub/"
license=('GPLv3')
backup=('etc/default/grub' 'etc/grub.d/40_custom')

makedepends=('git' 'autoconf' 'perl-locale-gettext')
depends=('glibc' 'udev' 'zlib' 'bzip2' 'libpng' 'freetype2' 'lvm2' 'xz')

source=(grub-${pkgver}::git+git://git.sv.gnu.org/grub.git#tag=${_GRUB_GIT_TAG})
sha256sums=(SKIP)

_COMMON_FLAGS=" --prefix=/usr --bindir=/usr/bin --sbindir=/usr/bin --libdir=/usr/lib/${MULTIARCH} --infodir=/usr/info --mandir=/usr/man --sysconfdir=/etc --with-bootdir=/boot --disable-werror"

_build_bios() {
	msg "Building grub BIOS"
	cd "${srcdir}"
	cp -R grub-${pkgver} grub-${pkgver}-bios
	cd grub-${pkgver}-bios
	rm -rf .git

	./autogen.sh
	./configure ${_COMMON_FLAGS}
	make
}

_build_efi() {
	msg "Building grub EFI"
	cd "${srcdir}"
	cp -r grub-${pkgver} grub-${pkgver}-efi
	cd grub-${pkgver}-efi

	./autogen.sh
	./configure ${_COMMON_FLAGS} \
                 --with-platform=efi \
                 --disable-efiemu \
                 --target=x86_64
	make
}

build() {
	unset CPPFLAGS
	unset CFLAGS
	unset CXXFLAGS
	unset LDFLAGS
	unset MAKEFLAGS

	_build_bios
	_build_efi
}

_package_bios() {
	msg "Packaging grub BIOS"
	cd "${srcdir}"/grub-${pkgver}-bios
	
	make install DESTDIR="${pkgdir}"/
}

_package_efi() {
	msg "Packaging grub EFI"
	cd "${srcdir}"/grub-${pkgver}-bios

	make install DESTDIR="${pkgdir}"/
}

package() {
	_package_bios
	_package_efi
}
